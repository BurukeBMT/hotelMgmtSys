rules_version = '2';

// FIRESTORE RULES
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             getUserRole() in ['super_admin', 'admin', 'manager'];
    }

    // Helper function to check if user is owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Allow owners to read their profile (get). Avoid using isAdmin() here
      // to prevent potential recursive get() evaluations in rules.
      allow get: if isAuthenticated() && isOwner(userId);

      // Users can update their own profile (except role)
      allow update: if isAuthenticated() && isOwner(userId) &&
                     (!('role' in request.resource.data.diff(resource.data).affectedKeys()) || isAdmin());

      // Allow users to create their own profile document (during sign-up)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Authenticated users can read bookings
      allow read: if isAuthenticated();
      // Users can create bookings
      allow create: if isAuthenticated();
      // Users can update their own bookings, admins can update any
      allow update: if isAuthenticated() &&
                     (resource.data.guestId == request.auth.uid || isAdmin());
      // Only admins can delete bookings
      allow delete: if isAdmin();
    }

    // Rooms collection
    match /rooms/{roomId} {
      // Anyone authenticated can read rooms
      allow read: if isAuthenticated();
      // Only admins can create/update/delete rooms
      allow write: if isAdmin();
    }

    // Guests collection
    match /guests/{guestId} {
      // Authenticated users can read guests
      allow read: if isAuthenticated();
      // Users can create guests, admins can update/delete
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Employees collection
    match /employees/{employeeId} {
      // Only HR/admins can access
      allow read, write: if isAdmin();
    }

    // Payments collection
    match /payments/{paymentId} {
      // Users can read their own payments
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());
      // Users can create payments, admins can update/delete
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read/update their own notifications
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      // Admins can create notifications
      allow create: if isAdmin();
      allow delete: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
    }

    // Pricing collection
    match /pricing/{pricingId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if isAdmin();
    }

    // Cabins collection
    match /cabins/{cabinId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if isAdmin();
    }

    // Departments collection
    match /departments/{departmentId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if isAdmin();
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      // Employees can read their own attendance, admins can read all
      allow read: if isAuthenticated() &&
                   (resource.data.employee_id == request.auth.uid || isAdmin());
      // Only admins/HR can create/update attendance
      allow write: if isAdmin();
    }

    // Payroll collection
    match /payroll/{payrollId} {
      // Employees can read their own payroll, admins can read all
      allow read: if isAuthenticated() &&
                   (resource.data.employee_id == request.auth.uid || isAdmin());
      // Only admins/HR can create/update payroll
      allow write: if isAdmin();
    }

    // Privileges collection
    match /privileges/{privilegeId} {
      // Anyone authenticated can read privileges
      allow read: if isAuthenticated();
      // Only admins can write privileges
      allow write: if isAdmin();
    }

    // User privileges collection
    match /user_privileges/{privilegeId} {
      // Users can read their own privileges, admins can read all
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());
      // Only admins can write user privileges
      allow write: if isAdmin();
    }
  }
}

// STORAGE RULES - DISABLED (Requires billing for Firebase Storage)
// To enable storage, uncomment and enable billing in Firebase Console
/*
service firebase.storage {
  match /b/{bucket}/o {
    // Storage disabled to avoid billing requirements
    // Uncomment below rules if you enable billing and want file storage

    // Users can upload files to their own folder
    match /users/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Public read, admin write for hotel assets
    match /hotel/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if false; // Disable writes for now, or add admin check via Firestore
    }

    // Booking attachments
    match /bookings/{bookingId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
*/
